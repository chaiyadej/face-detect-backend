<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Face Detection (Full Data Fix)</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        background: #222;
        color: white;
        margin: 0;
        padding-top: 20px;
      }

      .container {
        position: relative;
        margin: 10px auto;
        width: 640px;
        height: 480px;
        border: 3px solid #444;
        background: #000;
        overflow: hidden;
        border-radius: 8px;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
        display: block;
      }

      canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
        pointer-events: none;
      }

      .controls {
        margin-top: 20px;
      }

      button {
        padding: 15px 30px;
        font-size: 20px;
        cursor: pointer;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: 0.2s;
      }
      button:disabled {
        background: #555;
        cursor: not-allowed;
      }

      #status_msg {
        margin-top: 15px;
        font-size: 18px;
        color: yellow;
        min-height: 30px;
      }
    </style>
  </head>

  <body>
    <h1>üì∏ Face Detection (Server Sync)</h1>

    <div class="container">
      <video id="input_video" autoplay playsinline muted></video>
      <canvas id="output_canvas"></canvas>
    </div>

    <div class="controls">
      <button id="btnSnap" onclick="captureSnapshot()" disabled>
        ‚è≥ System Initializing...
      </button>
    </div>

    <div id="status_msg">1. Connecting Camera...</div>

    <script>
      const video = document.getElementById("input_video");
      const canvas = document.getElementById("output_canvas");
      const ctx = canvas.getContext("2d");
      const statusMsg = document.getElementById("status_msg");
      const btnSnap = document.getElementById("btnSnap");

      let model = null;
      let isCameraReady = false;

      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480, facingMode: "user" },
          });
          video.srcObject = stream;
          video.play();

          statusMsg.innerText = "2. Waiting for video stream...";

          const checkVideo = setInterval(() => {
            if (video.readyState >= 3 && video.videoWidth > 0) {
              clearInterval(checkVideo);
              onVideoReady();
            }
          }, 500);
        } catch (err) {
          console.error("Camera Error:", err);
          statusMsg.innerText = "‚ùå Camera Access Denied!";
        }
      }

      function onVideoReady() {
        if (isCameraReady) return;
        isCameraReady = true;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        statusMsg.innerText = "3. Camera OK! Loading AI...";
        loadAI();
      }

      async function loadAI() {
        try {
          model = await blazeface.load();
          console.log("AI Loaded!");
          btnSnap.disabled = false;
          btnSnap.innerText = "üì∏ CAPTURE & ANALYZE";
          statusMsg.innerText = "‚úÖ Ready!";
          statusMsg.style.color = "#0f0";
        } catch (err) {
          console.error(err);
          statusMsg.innerText = "‚ùå AI Load Failed";
        }
      }

      async function captureSnapshot() {
        if (!model) return;

        btnSnap.disabled = true;
        statusMsg.innerText = "üîç Scanning Face...";
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        try {
          const predictions = await model.estimateFaces(video, false);

          if (predictions.length > 0) {
            statusMsg.innerText = `Found ${predictions.length} Faces! Sending...`;
            statusMsg.style.color = "#ffcc00";

            predictions.forEach((pred) => {
              const start = pred.topLeft;
              const end = pred.bottomRight;
              const size = [end[0] - start[0], end[1] - start[1]];
              ctx.beginPath();
              ctx.rect(start[0], start[1], size[0], size[1]);
              ctx.lineWidth = 5;
              ctx.strokeStyle = "#00FF00";
              ctx.stroke();
            });

            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tCtx = tempCanvas.getContext("2d");
            tCtx.translate(tempCanvas.width, 0);
            tCtx.scale(-1, 1);
            tCtx.drawImage(video, 0, 0);

            // ‡πÉ‡∏ä‡πâ fullBase64 (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î) ‡πÅ‡∏•‡∏∞‡∏•‡∏î Quality ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0.5
            const fullBase64 = tempCanvas.toDataURL("image/jpeg", 0.5);

            sendToBackend(predictions.length, fullBase64);
          } else {
            statusMsg.innerText = "‚ö†Ô∏è No face detected.";
            statusMsg.style.color = "orange";
            setTimeout(resetUI, 1500);
          }
        } catch (err) {
          console.error(err);
          statusMsg.innerText = "‚ùå Error processing image";
          resetUI();
        }
      }

      function sendToBackend(count, imgData) {
        // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á .split()
        fetch("https://face-detect-backend-743m.onrender.com/detect-action", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            face_count: count,
            image: imgData,
          }),
        })
          .then(async (res) => {
            if (res.ok) {
              statusMsg.innerText = "‚úÖ Sent Successfully!";
            } else {
              // ‡∏≠‡πà‡∏≤‡∏ô Error ‡∏ó‡∏µ‡πà Server ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
              const errorJson = await res.json();
              console.error("Server Error Detail:", errorJson);
              statusMsg.innerText = `‚ùå Server Fail: ${errorJson.message || res.status}`;
            }
          })
          .catch((err) => {
            console.error("Fetch error:", err);
            statusMsg.innerText = "‚ùå Connection Failed";
          })
          .finally(() => setTimeout(resetUI, 3000));
      }

      function resetUI() {
        btnSnap.disabled = false;
        btnSnap.innerText = "üì∏ CAPTURE & ANALYZE";
        statusMsg.innerText = "‚úÖ Ready";
        statusMsg.style.color = "#0f0";
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      startCamera();
    </script>
  </body>
</html>
